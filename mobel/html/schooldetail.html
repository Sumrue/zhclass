<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta name="format-detection" content="telephone=no">
		<meta name="full-screen" content="yes">
		<meta name="browsermode" content="application">
		<meta name="x5-orientation" content="portrait">
		<meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.0.1/weui.min.css">
    <link rel="stylesheet" href="{MODULE_URL}template/mobile/{$template}/style/cssv2/swiper.min.css?v={$versions}" />
    <link rel="stylesheet" href="{MODULE_URL}template/mobile/{$template}/style/cssv2/index.css?v={$versions}"/>
    <link rel="stylesheet" href="{MODULE_URL}template/mobile/{$template}/style/cssv2/schooldetail.css"/>
		<title>
      学院详情
    </title>
  </head>
	<body data-weui-theme="light">
		<div class="page-container" id="page-container">
			<div class="school_detail">
        <div class="top_pic">
          <img src="{$_W['attachurl']}{$school['banner']}" alt="">
        </div>
        <!-- 切换导航 -->
        <div class="school_detail_navbar">
          <div class="school_navbar_item school_navbar_on">招生主页</div>
          <div class="school_navbar_item">学校介绍</div>
        </div>

        <div class="school_panel">
          <div class="panel panel_on">
            <div class="recruit_student_main">
              <!-- 上进礼包 -->
              <div class="school_gift">
                <div class="gift_title">
                  <span class="sale_price">{php echo intval($goods_config['price'])}</span>元(原价<span class="price">{$goods_config['oldprice']}</span>元)
                </div>
                <div class="gift_text">
                  <p>
                    <i class="star"><img src="{MODULE_URL}template/mobile/{$template}/images/index/school_detail/star.png" alt=""></i>
                    <span>{$goods_config['goodsdec1']}</span>
                  </p>
                  <p>
                    <i class="star"><img src="{MODULE_URL}template/mobile/{$template}/images/index/school_detail/star.png" alt=""></i>
                    <span>{$goods_config['goodsdec2']}</span>
                  </p>
                  <p>
                    <i class="star"><img src="{MODULE_URL}template/mobile/{$template}/images/index/school_detail/star.png" alt=""></i>
                    <span>{$goods_config['goodsdec3']}</span>
                  </p>
                  <p class="bottom_text">(上述考分不含政策性加分)</p>
                </div>
                  <a href="javascript::;" class="gift_btn">
                    立即购买
                  </a>
              </div>

              <!-- 院校专业以及收费 -->
              <div class="major_money">
                <div class="title">
                  <img src="{MODULE_URL}template/mobile/{$template}/images/index/school_detail/major_money_title.png" alt="">
                  <span>院校专业及收费</span>
                </div>
                <div>
                  <div class="school_major_item">
                    <div class="school_major_head">
                     <span class="text_title">{$school['name']}</span>
                    </div>
                    <div class="school_table">
                      <table>
                        <thead>
                          <tr>
                            <th width="60">招生层次</th>
                            <th width="150">招生专业</th>
                            <th width="80">学费 <br>(元/学年)</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- 判断是否有高起专层次 -->
                          {if $school[lid][1][id] == 1}
                          <tr>
                            <td>高起专</td>
                            <td class="table_major" id="level1">

                            </td>
                            <td><span>{$school[lid][1][price]}</span></td>
                          </tr>
                          {/if}
                        </tbody>
                        <tbody>
                           <!-- 判断是否有专升本层次 -->
                          {if $school[lid][2][id] == 2}
                          <tr>
                            <td>专升本</td>
                            <td class="table_major" id="level2"></td>
                            <td><span>{$school[lid][2][price]}</span></td>
                          </tr>
                          {/if}
                        </tbody>
                      </table>
                      <ul class="bottom_text">
                        <li class="bottom_text_li">教材费:

                          {if !empty($school[lid][1])}<span>{$school[lid][1][oprice]}</span>
                          {else}<span>{$school[lid][2][oprice]}</span>
                          {/if}
                        </li>
                        <li class="bottom_text_li" id="addrBox">考区: 
                          
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <!-- 上进故事 -->
              <div class="good_story">
                <div class="title">
                  <img src="{MODULE_URL}template/mobile/{$template}/images/index/school_detail/good_story_icon.png" alt="">
                  <span>上进故事</span>
                </div>
                <div class="good_story_banner">
                  <ul class="good_story_items">
                    <div class="clear"></div>
                  </ul>

                  <!-- 邀请有礼广告 -->
                  <div></div>
                </div>
              </div>
            </div>
          </div>
          <div class="panel">
            <!-- 学校介绍 -->
            <div class="school_detail_content">
              <!-- 介绍顶部 -->
              <div class="detail_content_head">
                <div class="text" id="mydiv">
                  
                </div>
              </div>
            </div>
            <div class="look_more">
              <div class="more">
                <img src="{MODULE_URL}template/mobile/{$template}/images/index/open_education/down_more.png" alt="">
                <p>查看更多</p>
              </div>
              <div class="up lookHidden">
                收起
              </div>
            </div>
            
            <!-- 学员风采 -->
            <div class="school_detail_student">
              <div class="title">
                <img src="{MODULE_URL}template/mobile/{$template}/images/index/school_detail/school_detail_stdenticon.png" alt="">
                <span>学员风采</span>
              </div>
            </div>
            {template $template.'/index/student_show'}
            <!-- 邀请好友广告位 -->
            <div></div>
          </div>
          
        </div>
        <!-- 留言区 -->
        <div class="school_voice_msg">
          <div class="title">
            <img src="{MODULE_URL}template/mobile/{$template}/images/index/school_detail/voice_msg_icon.png" alt="">
            <span>留言区</span>
          </div>
          <div class="school_voice_box">
            {template $template.'/index/voice2'}
          </div>
        </div>
        <div style="height: 1.2rem;"></div>
      </div>
    </div>
    <script type="text/javascript" src="{MODULE_URL}template/mobile/{$template}/style/jsv2/jquery.min.js?v={$versions}"></script>
    <script type="text/javascript" src="{MODULE_URL}template/mobile/{$template}/style/jsv2/swiper.3.4.1.min.js"></script>
    <script type="text/javascript" src="{MODULE_URL}template/mobile/{$template}/style/js/m-fit.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/libs/weuijs/1.2.1/weui.min.js"></script>
    <script>
      $(function(){
          // 对接收到的文章进行处理
          function escape2Html(str) { 
            var arrEntities={'lt':'<','gt':'>','nbsp':' ','amp':'&','quot':'"'}; 
            return str.replace(/&(lt|gt|nbsp|amp|quot);/ig,function(all,t){return arrEntities[t];}); 
            }
          let strrr = {php echo json_encode($school)};
          let addr = {php echo json_encode($addr)};
          let schollText = $('.detail_content_head .text')
          let contenttext = '{php echo json_encode($school['content'])}'
          let text = escape2Html(contenttext)
          let length = text.length
          let text2 = text.substr(1,length-2)
          $('#mydiv').html(text2)

          // swiper轮播
          let studentShowSwiper = new Swiper ('.student_show_swiper', {
            loop: true,
            direction: 'horizontal', // 方向
            autoplay: 2000, // 切换时间
            slidesPerView :'auto',
            loopedSlides :3,
            centeredSlides: true,
            spaceBetween : 40,
            effect : 'coverflow',
            coverflow: {
                      rotate: 0,
                      depth: 130,
                      slideShadows: false
                  },
            observer:true,//修改swiper自己或子元素时，自动初始化swiper
            observeParents:true,//修改swiper的父元素时，自动初始化swiper
          }) 

        // 导航和页面的切换
        let navBarItem = $('.school_navbar_item')
        let schoolPanel = $('.school_panel .panel')
        navBarItem.click(function(){
          let $this = $(this)
          let index = $this.index()
          $this.addClass('school_navbar_on').siblings('.school_navbar_on').removeClass('school_navbar_on') // 导航切换
          schoolPanel.eq(index).addClass('panel_on').siblings('.panel_on').removeClass('panel_on') // 页面切换

          // 常见问题页面中隐藏品论
          let vioceMsg = $('.school_voice_msg')
          if(index == 2) {
            vioceMsg.css('display','none')
          } else {
            vioceMsg.css('display','block')
          }

          // 初始化spiper轮播 去除display的影响
          studentShowSwiper.init();
        })

        // 主页留言的请求
        let voiceAjaxurl = "{php echo $this->createMobileUrl('evaluate', array('op'=>'getfree','method'=>'ajaxgetlist'));}"
        let voiceGetData = function () {
          $.get(voiceAjaxurl, function (data) {
            let voiceData = []
            if (data.length !== 0) {
              voiceData = JSON.parse(data)
            }else{
              console.log('获取数据失败')  //没有数据后，禁止请求获取数据
            }
          }).then(res=>{
              let voiceData = JSON.parse(res)
              let data = voiceData.list
              let voiceMsg = $('.voice_msg_ul')
              let voiceItem = $('.voice_li')
              let voiceItemIndex = data.length
              voiceMsg.html('')
              let vioceHtml = ''
              for(let i = 0; i < data.length; i ++){
              let myname = data[i].nickname
              let reply = data[i].reply
              if(data[i].reply == null ) {
                reply = ''
              } else {
                reply = data[i].reply
              }
              // 内容模板
              vioceHtml += `
              <li class="voice_message_item voice_li">
                <div class="message_item_pic">
                  <img src="${data[i].avatar}" alt="">
                </div>
                <div class="message_item">
                  <p class="name">${myname.slice(0,1)}**</p>
                  <p class="question">问：${data[i].content}</p>
                  <p class="reply">回复：<span>${reply}</span></p>
                </div>
              </li>
              `
            }
            voiceMsg.append(vioceHtml)
            if(voiceItemIndex > 15) { // 限制为15条留言
                voiceItemIndex = 15
              } else {
                voiceItemIndex -= 2
              }
              
              let i = 0
              setInterval(() => {
                i ++
                if(i > voiceItemIndex - 1) {
                  i = 0
                  voiceMsg.css('top',0)
                }
                voiceMsg.animate(
                  {top: -3*i + 'rem'}
                )
              }, 3000);
          })
        }
        voiceGetData()


        // 学员故事分享
        let articHtml = function(){
          let ajaxurl = "{php echo $this->createMobileUrl('article', array('op'=>'list',cate_id=>$_GPC['cate_id'],'method'=>'ajaxgetlist'));}";
          let articleurl = "{php echo $this->createMobileUrl('article');}";
          let get_status = true; //允许获取状态
          let getData = function () {  
            $.get(ajaxurl, function (data) {
              let jsonObj = JSON.parse(data);
              if (jsonObj.length !== 0) {
                insertDiv(jsonObj);
              }else{
                console.log('获取数据失败')  //没有数据后，禁止请求获取数据
              }
            })
          }
          getData()

          // 内容插入
          let insertDiv =  function(res){
            let storeItems = $('.good_story_items')
            let html = ''
            let articleurl = "{php echo $this->createMobileUrl('article');}";
            for(let i = 0; i<res.length; i++){
              html += `
                <li class="good_story_item">
                  <a href="${articleurl}&aid=${res[i].id}">
                      <div class="pic">
                        <img src="${res[i].images}" alt="">
                      </div>
                      <p class="text">${res[i].title}</p>
                      <p class="date">${res[i].addtime}</p>
                    </a>
                </li>
              `
            }
            storeItems.append(html)
          }
        }
        articHtml()

        // 初始化时学校信息的渲染
        let level1Box = $('#level1')
        let level2Box = $('#level2')
        let html = ''
        let level1Data = []
        let level2Data = []
        let levelData = strrr.lid
        let addrData = JSON.parse(strrr.area)

        // 高起专和专升本都存在情况下
        if (levelData[2] && levelData[1]) {
          for(let i = 1; i < 3; i++) {
            let majorUrl = '{php echo $this->createMobileUrl("adultuserform", array("at"=>"pro"));}' + '&lid=' + levelData[i].id + '&id=' + '{php echo $_GPC["id"];}'
            $.get(majorUrl,function(data){
              console.log('发送请求专业信息,都存在')
            }).then(res => {
              let resData = JSON.parse(res)
              if(i == 1) {
                for(let j = 0;j < resData.length; j ++) {
                  let html = ''
                  html = `
                    <span>${resData[j].name}</span>、
                  `
                  level1Box.append(html)
                }
              } else{
                for(let j = 0;j < resData.length; j ++) {
                  let html = ''
                  html = `
                    <span>${resData[j].name}</span>、
                  `
                  level2Box.append(html)
                }
              }
            })
          }
          // 只有一个层次的情况下的处理
        } else if(levelData[2] || levelData[1]){
          for(key in levelData) {
            let majorUrl = '{php echo $this->createMobileUrl("adultuserform", array("at"=>"pro"));}' + '&lid=' + levelData[key].id + '&id=' + '{php echo $_GPC["id"];}'
            $.get(majorUrl,function(data){
                console.log('发送请求专业信息')
              }).then(res => {
                let resData = JSON.parse(res)
                let html = ''
                    html = `
                      <span>${resData[0].name}</span>、
                    `
                    level1Box.append(html)
                    level2Box.append(html)
            })
          }
        }

        // 循环出地址
        let addrArr = []
        let addrBox = $('#addrBox')
        let addrHtml = ''
        for(let i = 0; i < addrData.length; i++){
          addrArr.push(addrData[i].tid)
        }
        // 根据获取的地址循环出真正的地址
        for(let i = 0; i < addrArr.length; i++){
          for(let j = 0; j < addr.length; j++) {
            if(addrArr[i] == addr[j].id) {
              addrHtml = `
                <span>${addr[j].ext_name}</span>、
              `
              
            }
          }
          addrBox.append(addrHtml)
        }
      }) // $(function()) 结束

    // 购买礼包跳转
    let giftBtn = $('.gift_btn')
    giftBtn.click(
      function(){
        // 根据商品ID来创建订单，跳转至订单页面
        let url = '{php echo $this->createMobileUrl("adultuserform", array("do"=>"adultuserform","type"=>"adult","exist299"=>"true","cid"=>"1"));}'
        location.href = url
      }
    )
      // 留言提交
    function sendMsg(event){
			// 注册手机号后才可以提交评论
			let phone = {php echo json_encode($_W['member']['mobile'])};
			if(phone == '') { // 手机号不存在，即没有注册，则跳转至注册页面
			location.href = '{php echo $this->createMobileUrl("writemsg", array("do"=>"writemsg","op"=>"modifyMobile"));}'
			}else {
				// 获取留言框中的内容
				let content = $(event).parent().find('.voice_box').val()
				// 成功的弹出框
				let $toast = $(event).parent().siblings('#toast')
				// 成功后内容框
				let tostMsg = $('.weui-toast_msg')
				// 失败的弹出框
				let $iosDialog2 = $(event).parent().siblings('#iosDialog2')
				// 失败弹出后关闭按钮
				let iosDialog2Close = $(event).parent().siblings('#iosDialog2').find('#iosDialog2_close')

				// 请求地址
				let voicePostAjaxurl = "{php echo $this->createMobileUrl('evaluate', array('op'=>'free','method'=>'ajaxgetlist'));}"
				// 判断输入框内容是否为空，为空时则不发送请求
				if(content == '') {
					return
				} else{
				$.post(voicePostAjaxurl,{
						content: content
					},function (data) {
						console.log('留言提交')
				}).then(res=>{
					let resData = JSON.parse(res) // 转化数据
					
					if (resData.code == 1) { // 留言成功
						tostMsg.text(resData.msg)
						if ($toast.css('display') != 'none') return;
							$toast.fadeIn(100);
							setTimeout(function () {
									$toast.fadeOut(100);
							}, 2000);
					} else if (resData.code == 0) { // 留言失败
						$iosDialog2.fadeIn(200)
						iosDialog2Close.click(function(){
							$iosDialog2.fadeOut(200)
						})
					} else {
						alert('未知错误，请联系网站管理员')
					}
				})
				// 提交后清空
				$('.voice_box').val('')
				}
			}
    }
    
    // 监听评论功能输入时的输入限制显示
    $(".voice_box").on('input propertychange', function () {
      //获取输入内容
      let userDesc = $(this).val();
      //判断字数
      let len = userDesc.length
      if (len<=50) {
        $(".main_num").html(len + '/50')
      } else {
          return
      }
      //显示字数
    });

    // // 常见问题展开关闭代码
    // let wuiCell = $('.weui-cell')
    // let leftIcon = $('.left_icon')
    // wuiCell.click(
    // function(){
    //   let collapseCount = $(this).parent().children('.collapse_content') // 获取当前需要展开或者关闭的内容框
    //   let boxHt = collapseCount.children('.padding_box').height() // 动态获取盒子高度，方便内容过多时挤出去。需要设置默认高度时可以设置这个为固定值，例如60
    //   let collIcon = $(this).children('.left_icon')
    //   let collapseHt = collapseCount.height() // 获取当前内容框的高度，是否展开

    //   // 首先将其他已展开或未展开的内容框重置为零，即手风琴效果，如不需要手风琴效果就可以去掉下面重置两项
    //   collapseCount.parent().siblings().children('.collapse_content').animate( // 重置其他的选项
    //       {height: 0},
    //       {duration: 200}
    //   )
    //   leftIcon.addClass('weui-cell__ft').removeClass('weui-cell__ft_on') // 变化前箭头全部重置为初始状态

    //   // 判断当前是否展开，即高度是否为零，已展开点击栏目时关闭
    //   if(collapseHt !== 0) { // 已展开时
    //       collIcon.removeClass('weui-cell__ft_on').addClass('weui-cell__ft') // 加入箭头向下的样式移除原样式
    //       collapseCount.animate(
    //           {height: 0},
    //           {duration: 200}
    //       )
    //   } else {
    //       collIcon.addClass('weui-cell__ft_on').removeClass('weui-cell__ft')
    //       collapseCount.animate(
    //           {height: boxHt + 35}, // 有个BUG，必须要加20 不然盒子展开少一截，我也不知道错在哪儿。。。。。
    //           {duration: 200}
    //       )
    //     }
    //   }
    // )

    // 学校介绍内容的展开关闭
    let schoolText  = $('.school_detail_content .text')
    let lookMore = $('.look_more .more')
    let closeMore = $('.look_more .up')
    lookMore.click(function(){
      $(this).addClass('lookHidden')
      closeMore.removeClass('lookHidden')
      schoolText.height('100%')
    })
    closeMore.click(function(){
      $(this).addClass('lookHidden')
      lookMore.removeClass('lookHidden')
      schoolText.height('3rem')
    })
    </script>
{template $template.'/_footerv2'}